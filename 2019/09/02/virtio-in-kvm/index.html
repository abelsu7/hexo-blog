<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    

    

    
<!-- Baidu Tongji -->
<script>var _hmt = _hmt || []</script>
<script async src="//hm.baidu.com/hm.js?c61262c25ca5d4ed66df331a31b5bf49"></script>
<!-- End Baidu Tongji -->




    <meta charset="utf-8">
    
    <meta name="google-site-verification" content="cc3c_UncRv21aEZwqejVxKpUMR7h9ldNUTeYjawUS-g">
    
    
    <meta name="baidu-site-verification" content="HnoV7q61W5">
    
    
    
    <title>半虚拟化 I/O 框架 virtio | Keep Coding | 苏易北</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="KVM,虚拟化,QEMU,virtio">
    <meta name="description" content="virtio 框架学习，更新中…">
<meta name="keywords" content="KVM,虚拟化,QEMU,virtio">
<meta property="og:type" content="article">
<meta property="og:title" content="半虚拟化 I&#x2F;O 框架 virtio">
<meta property="og:url" content="https://abelsu7.top/2019/09/02/virtio-in-kvm/index.html">
<meta property="og:site_name" content="Keep Coding">
<meta property="og:description" content="virtio 框架学习，更新中…">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://abelsu7.top/2019/09/02/virtio-in-kvm/cover.png">
<meta property="og:image" content="https://abelsu7.top/2019/09/02/virtio-in-kvm/qemu-soft-io.jpg">
<meta property="og:image" content="https://abelsu7.top/2019/09/02/virtio-in-kvm/virtio-overview.jpg">
<meta property="og:image" content="https://abelsu7.top/2019/09/02/virtio-in-kvm/architecture.gif">
<meta property="og:image" content="https://abelsu7.top/2019/09/02/virtio-in-kvm/virtio-layer.png">
<meta property="og:image" content="https://abelsu7.top/2019/09/02/virtio-in-kvm/virtio-data-structure.gif">
<meta property="og:updated_time" content="2019-11-19T13:34:08.676Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="半虚拟化 I&#x2F;O 框架 virtio">
<meta name="twitter:description" content="virtio 框架学习，更新中…">
<meta name="twitter:image" content="https://abelsu7.top/2019/09/02/virtio-in-kvm/cover.png">
    
        <link rel="alternate" type="application/atom+xml" title="Keep Coding" href="/atom.xml">
    
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    <link rel="stylesheet" href="/css/prism/prism-tomorrow-night.css?v=1.7.2">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-list-ul"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/back_blue.png)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/fong.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Abel Su</h5>
          <a href="mailto:abelsu7@gmail.com" title="abelsu7@gmail.com" class="mail">abelsu7@gmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives/"  >
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/"  >
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags/"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://notes.abelsu7.top"  >
                <i class="icon icon-lg icon-sticky-note"></i>
                笔记
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/abelsu7"  >
                <i class="icon icon-lg icon-github"></i>
                代码
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/friends/"  >
                <i class="icon icon-lg icon-user"></i>
                友链
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/bookmarks/"  >
                <i class="icon icon-lg icon-bookmark"></i>
                收藏
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/books/"  >
                <i class="icon icon-lg icon-book"></i>
                读书
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/movies/"  >
                <i class="icon icon-lg icon-film"></i>
                影视
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/games/"  >
                <i class="icon icon-lg icon-gamepad"></i>
                游戏
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://notes.abelsu7.top/#/links/wechat"  >
                <i class="icon icon-lg icon-wechat"></i>
                微信
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/2018/09/21/how-to-learn-coding/"  >
                <i class="icon icon-lg icon-code"></i>
                学习
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/wiki/"  >
                <i class="icon icon-lg icon-sort-alpha-asc"></i>
                速查
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about/"  >
                <i class="icon icon-lg icon-info-circle"></i>
                关于
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">半虚拟化 I/O 框架 virtio</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">半虚拟化 I/O 框架 virtio</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-09-02T03:05:18.000Z" itemprop="datePublished" class="page-time">
  2019-09-02
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/KVM/">KVM</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-virtio-概述"><span class="post-toc-text">1. virtio 概述</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-软件方式模拟-I-O-设备"><span class="post-toc-text">2. 软件方式模拟 I/O 设备</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-1-基本原理"><span class="post-toc-text">2.1 基本原理</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-2-优缺点"><span class="post-toc-text">2.2 优缺点</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-半虚拟化-I-O-框架-virtio"><span class="post-toc-text">3. 半虚拟化 I/O 框架 virtio</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-1-基本原理"><span class="post-toc-text">3.1 基本原理</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-2-优缺点"><span class="post-toc-text">3.2 优缺点</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-virtio-的架构"><span class="post-toc-text">4. virtio 的架构</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-1-版本要求"><span class="post-toc-text">4.1 版本要求</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-层次结构"><span class="post-toc-text">4.2 层次结构</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-3-前端代码层次结构"><span class="post-toc-text">4.3 前端代码层次结构</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#相关源码文件"><span class="post-toc-text">相关源码文件</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#类结构层次"><span class="post-toc-text">类结构层次</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#virtio-driver"><span class="post-toc-text">virtio_driver</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#virtio-device-id"><span class="post-toc-text">virtio_device_id</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#virtio-device"><span class="post-toc-text">virtio_device</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#virtio-config-ops"><span class="post-toc-text">virtio_config_ops</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#virtqueue"><span class="post-toc-text">virtqueue</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-相关数据结构"><span class="post-toc-text">5. 相关数据结构</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#5-1-前端-Kernel"><span class="post-toc-text">5.1 前端 Kernel</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#virtio-driver-1"><span class="post-toc-text">virtio_driver</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#virtio-device-1"><span class="post-toc-text">virtio_device</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#virtio-config-ops-1"><span class="post-toc-text">virtio_config_ops</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#virtqueue-1"><span class="post-toc-text">virtqueue</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#5-2-后端-QEMU"><span class="post-toc-text">5.2 后端 QEMU</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#VirtQueue"><span class="post-toc-text">VirtQueue</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#VRing"><span class="post-toc-text">VRing</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#参考文章"><span class="post-toc-text">参考文章</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#相关博客"><span class="post-toc-text">相关博客</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#官方文档"><span class="post-toc-text">官方文档</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#太初有道-博客园"><span class="post-toc-text">太初有道 - 博客园</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Lauren-的博客"><span class="post-toc-text">Lauren 的博客</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#其他不错的"><span class="post-toc-text">其他不错的</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#团子的小窝"><span class="post-toc-text">团子的小窝</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#QEMU"><span class="post-toc-text">QEMU</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Linux-云计算网络"><span class="post-toc-text">Linux 云计算网络</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#王子阳-中科院信息工程研究所"><span class="post-toc-text">王子阳 - 中科院信息工程研究所</span></a></li></ol></li></ol>
        </nav>
    </aside>


<article id="post-virtio-in-kvm"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">半虚拟化 I/O 框架 virtio</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-09-02 11:05:18" datetime="2019-09-02T03:05:18.000Z"  itemprop="datePublished">2019-09-02</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/KVM/">KVM</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <blockquote>
<p><strong><em>virtio 框架学习，更新中…</em></strong></p>
</blockquote>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/02/virtio-in-kvm/cover.png" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>
<a id="more"></a>
<h3 id="1-virtio-概述"><a href="#1-virtio-概述" class="headerlink" title="1. virtio 概述"></a>1. virtio 概述</h3><p><strong>KVM</strong> 是必须依赖<strong>硬件虚拟化技术</strong>辅助（例如 Intel VT-x、AMD-V）的 Hypervisor：</p>
<ul>
<li><strong>CPU</strong>：有 <strong>VMX root</strong> 和 <strong>non-root 模式</strong>的支持，其运行效率是比较高的</li>
<li><strong>内存</strong>：有 <strong>Intel EPT/AMD NPT</strong> 的支持，内存虚拟化的效率也比较高</li>
<li><strong>I/O</strong>：KVM 客户机的 I/O 操作需要<code>VM-Exit</code>到用户态由 QEMU 进行模拟。传统的方式是使用纯软件的方式来模拟 I/O 设备，效率并不高</li>
</ul>
<blockquote>
<p>为了解决 I/O 虚拟化效率低下的问题，可以在客户机中使用<strong>半虚拟化驱动</strong>（Paravirtualized Drivers，PV Drivers）来提高客户机的 I/O 性能。目前，KVM 中实现半虚拟化驱动的方式就是采用了<code>virtio</code>这个 Linux 下的设备驱动标准框架。</p>
</blockquote>
<p><strong>virtio</strong> 是 Linux 平台下一种 <strong>I/O 半虚拟化框架</strong>，由澳大利亚程序员 Rusty Russell 开发。他当时的目的是支持自己的虚拟化解决方案 Lguest，而在 KVM 中也广泛使用了 Virtio 作为半虚拟化 I/O 框架。</p>
<h3 id="2-软件方式模拟-I-O-设备"><a href="#2-软件方式模拟-I-O-设备" class="headerlink" title="2. 软件方式模拟 I/O 设备"></a>2. 软件方式模拟 I/O 设备</h3><h4 id="2-1-基本原理"><a href="#2-1-基本原理" class="headerlink" title="2.1 基本原理"></a>2.1 基本原理</h4><p>下图是 QEMU 以<strong>纯软件方式模拟 I/O 设备</strong>的示意图：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/02/virtio-in-kvm/qemu-soft-io.jpg" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>
<ul>
<li>当 Guest 中的设备驱动程序<strong>发起 I/O 操作请求</strong>时，KVM 模块中的 <strong>I/O Trap Code 会拦截这次 I/O 请求</strong>，经过处理后将本次 I/O 请求的信息存放到 <strong>I/O sharing page</strong> 中，并通知用户空间的 QEMU</li>
<li>QEMU 从 I/O sharing page 中获得 I/O 操作的具体信息后，交由<strong>硬件模拟代码（QEMU I/O Emulation Code）</strong>来模拟本次 I/O 操作</li>
<li>模拟代码负责<strong>和实际的设备驱动进行交互，模拟此次 I/O 操作</strong>，获取返回结果并将其放回 I/O Sharing Page 中</li>
<li>最后，KVM 中的 I/O Trap Code 负责读取 I/O Sharing Page 中的操作结果，并<strong>将结果返回到客户机中</strong></li>
</ul>
<p>需要注意的是：</p>
<ul>
<li><strong>客户机</strong>作为一个QEMU 进程，在<strong>等待 I/O 时也可能被阻塞</strong></li>
<li>当<strong>客户机通过 DMA 方式访问大块 I/O</strong> 时，QEMU 不会把 I/O 操作结果放到 I/O 共享页中，而是通过<strong>内存映射</strong>的方式将结果直接写进客户机的内存中，然后通过 KVM 模块告诉客户机 DMA 操作已经完成</li>
</ul>
<h4 id="2-2-优缺点"><a href="#2-2-优缺点" class="headerlink" title="2.2 优缺点"></a>2.2 优缺点</h4><ul>
<li>优点：可以通过软件模拟出各类硬件设备，而<strong>无需修改客户机操作系统</strong></li>
<li>缺点：每次 <strong>I/O 操作的路径较长</strong>，有较多的<code>VM-Entry</code>、<code>VM-Exit</code>发生，需要<strong>多次上下文切换</strong>，也需要<strong>多次数据复制</strong>，因此性能较差</li>
</ul>
<h3 id="3-半虚拟化-I-O-框架-virtio"><a href="#3-半虚拟化-I-O-框架-virtio" class="headerlink" title="3. 半虚拟化 I/O 框架 virtio"></a>3. 半虚拟化 I/O 框架 virtio</h3><h4 id="3-1-基本原理"><a href="#3-1-基本原理" class="headerlink" title="3.1 基本原理"></a>3.1 基本原理</h4><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/02/virtio-in-kvm/virtio-overview.jpg" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>
<p>如图所示，virtio 分为了<strong>前端驱动</strong>和<strong>后端驱动</strong>：</p>
<ul>
<li><strong>前端驱动 frontend</strong>：如<code>virtio_blk</code>、<code>virtio_net</code>等，是在客户机中存在的<strong>驱动程序模块</strong></li>
<li><strong>后端驱动 backend</strong>：在 QEMU 中实现</li>
</ul>
<p>在前后端驱动之间，还定义了两层来支持客户机和 QEMU 之间的通信：</p>
<ul>
<li><strong>virtio 层</strong>：<strong>虚拟队列接口</strong>，它在概念上将前端驱动程序附加到后端处理程序。<strong><em>一个前端驱动程序可以使用 0 个或多个队列</em></strong>，具体数量取决于需求</li>
</ul>
<blockquote>
<p>例如：<code>virtio_net</code>网络驱动程序使用<strong>两个虚拟队列（接收/发送）</strong>，而<code>virtio_blk</code>驱动仅使用<strong>一个虚拟队列</strong>。<br>虚拟队列实际上被实现为客户机操作系统和 Hypervisor 之间的衔接点，但它可以通过任意方式实现，前提是客户机操作系统和 virtio 后端程序都遵循一定的标准，以相互匹配的方式实现它。</p>
</blockquote>
<ul>
<li><strong>virtio-ring 层</strong>：实现了<strong>环形缓冲区（ring buffer）</strong>，用于保存前端驱动和后端处理程序执行的信息，并且它可以<strong>一次性保存前端驱动的多次 I/O 请求，再交由后端驱动批量处理</strong>，最后实际调用宿主机中的设备驱动来完成物理层面上的 I/O 操作。</li>
</ul>
<blockquote>
<p>这样做就可以根据约定实现<strong>批量处理</strong>而不是客户机中每次 I/O 请求都需要处理一次，从而<strong>提高了客户机与 Hypervisor 之间信息交换的效率</strong></p>
</blockquote>
<h4 id="3-2-优缺点"><a href="#3-2-优缺点" class="headerlink" title="3.2 优缺点"></a>3.2 优缺点</h4><ul>
<li>优点：可获得很好的 I/O 性能，接近 Native。所以在使用 KVM 时，如果宿主机和客户机都支持 Virtio，一般都推荐使用 Virtio 以达到更高的 I/O 性能</li>
<li>缺点：必须在客户机中安装前端驱动，且按照 Virtio 的规定格式进行数据传输</li>
</ul>
<h3 id="4-virtio-的架构"><a href="#4-virtio-的架构" class="headerlink" title="4. virtio 的架构"></a>4. virtio 的架构</h3><p><strong>virtio</strong> 是半虚拟化的解决方案，是<strong>半虚拟化 Hypervisor</strong> 的一组<strong>通用 I/O 设备的抽象</strong>。它提供了一套上层应用与各 Hypervisor 虚拟化设备（KVM、Xen、VMware 等）之间的通信框架和编程接口，减少了跨平台所带来的兼容性问题。<strong>客户机需要知道自己运行在虚拟化环境中</strong>，进而根据 Virtio 标准和 Hypervisor 协作，从而提高 I/O 性能。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/02/virtio-in-kvm/architecture.gif" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>
<ul>
<li><strong>前端驱动</strong>：Frontend Driver，是位于<strong>客户机内核</strong>中的<strong>驱动程序模块</strong></li>
<li><strong>后端驱动</strong>：Backend Driver，在<strong>宿主机用户空间</strong>的 <strong>QEMU</strong> 中实现</li>
</ul>
<blockquote>
<p>virtio 是半虚拟化驱动框架，可以提供接近 Native 的 I/O 性能，但是客户机中必须安装特定的 virtio 驱动，并按照 virtio 的规定格式进行数据传输</p>
</blockquote>
<h4 id="4-1-版本要求"><a href="#4-1-版本要求" class="headerlink" title="4.1 版本要求"></a>4.1 版本要求</h4><p><code>Kernel &gt;= 2.6.25</code>的内核都支持 virtio。由于 virtio 的后端处理程序是在位于用户空间中的 QEMU 中实现的，所以<strong>宿主机只需要比较新的内核即可</strong>，不需要特别编译 virtio 相关驱动。而<strong>客户机需要有特定 virtio 驱动程序的支持</strong>，以便客户机处理 I/O 操作请求时调用前端驱动。</p>
<p><strong>客户机内核</strong>中关于 virtio 的部分配置如下：</p>
<pre><code class="lang-bash"># 需要启用的选项
CONFIG_VIRTIO_PCI=m
CONFIG_VIRTIO_BALLOON=m
CONFIG_VIRTIO_BLK=m
CONFIG_VIRTIO_NET=m
CONFIG_VIRTIO=m
CONFIG_VIRTIO_RING=y

# 其他相关的选项
CONFIG_VIRTIO_VSOCKETS=m
CONFIG_VIRTIO_VSOCKETS_COMMON=m
CONFIG_SCSI_VIRTIO=m
CONFIG_VIRTIO_CONSOLE=m
CONFIG_HW_RANDOM_VIRTIO=m
CONFIG_DRM_VIRTIO_GPU=m
CONFIG_VIRTIO_PCI_LEGACY=y
CONFIG_VIRTIO_INPUT=m
# CONFIG_VIRTIO_MMIO is not set

# 在子机中查看 VIRTIO 相关内核模块
&gt; lsmod | grep virtio
virtio_balloon         18015  0 
virtio_net             28063  0 
virtio_blk             18166  2 
virtio_pci             22934  0 
virtio_ring            22746  4 virtio_blk,virtio_net,virtio_pci,virtio_balloon
virtio                 14959  4 virtio_blk,virtio_net,virtio_pci,virtio_balloon
</code></pre>
<h4 id="4-2-层次结构"><a href="#4-2-层次结构" class="headerlink" title="4.2 层次结构"></a>4.2 层次结构</h4><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/02/virtio-in-kvm/virtio-layer.png" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>
<p>如图所示，virtio 大致分为三个层次：<strong>前端驱动</strong>（位于客户机）、<strong>后端驱动</strong>（位于 QEMU）以及中间的<strong>传输层</strong>。</p>
<p>每一个 virtio 设备（块设备、网卡等）在系统层面看来，都是一个 <strong>PCI 设备</strong>。这些设备之间有共性部分，也有差异部分。</p>
<p><strong>共性部分</strong>：</p>
<ol>
<li>都需要<strong>挂接相应的 buffer 队列操作 virtqueue_ops</strong></li>
<li>都需要<strong>申请若干个 buffer 队列</strong>，当执行 I/O 输出时，需要<strong>向队列写入数据</strong></li>
<li>都需要<strong>执行 pci_iomap 将设备配置寄存器区间映射到内存区间</strong></li>
<li>都需要<strong>设置中断处理</strong></li>
<li>等中断来了，都需要<strong>从队列读出数据</strong>，并<strong>通知客户机系统，数据已入队</strong></li>
</ol>
<p><strong>差异部分</strong>：</p>
<ul>
<li>与设备相关联的系统、业务、队列中<strong>写入的数据含义各不相同</strong></li>
<li>例如，网卡在内核中是一个<code>net_device</code>，与协议栈系统关联起来。同时，向队列中写入什么数据、数据的含义如何，各个设备也不相同。队列中来了什么数据，是什么含义，如何处理，各个设备也不相同</li>
</ul>
<blockquote>
<p>如果每个 virtio 设备都完整的实现自己的功能，就会造成不必要的代码冗余。针对这个问题，virtio 又设计了<code>virtio_pci</code>模块，以处理所有 virtio 设备的共性部分。这样一来<strong>所有的 virtio 设备在系统看来都是一个 PCI 设备，其设备驱动都是</strong><code>virtio_pci</code></p>
</blockquote>
<p>但是，<code>virtio_pci</code>并不能完整的驱动任何一个设备。因此，<code>virtio_pci</code>在调用<code>probe()</code>接管每一个设备时，会<strong>根据其</strong><code>virtio_device_id</code><strong>来识别出具体是哪一种设备</strong>，然后相应的<strong>向内核注册一个 virtio 类型的设备</strong>。</p>
<p>在注册设备之前，<code>virtio_pci</code>驱动已经为该设备做了许多<strong>共性操作</strong>，同时还为该设备提供了各种操作的<strong>适配接口</strong>，这些都通过<code>virtio_config_ops</code>来适配。</p>
<h4 id="4-3-前端代码层次结构"><a href="#4-3-前端代码层次结构" class="headerlink" title="4.3 前端代码层次结构"></a>4.3 前端代码层次结构</h4><h5 id="相关源码文件"><a href="#相关源码文件" class="headerlink" title="相关源码文件"></a>相关源码文件</h5><p><code>Kernel 3.10.0</code>中关于 virito 的<strong>重要源码文件</strong>如下：</p>
<pre><code class="lang-c">drivers/block/virtio_blk.c
drivers/char/hw_random/virtio_rng.c
drivers/char/virtio_console.c
drivers/net/virtio_net.c
drivers/scsi/virtio_scsi.c
drivers/virtio/virtio_balloon.c
drivers/virtio/virtio_mmio.c
drivers/virtio/virtio_pci.c
drivers/virtio/virtio_ring.c
drivers/virtio/virtio.c

include/linux/virtio_caif.h
include/linux/virtio_config.h
include/linux/virtio_console.h
include/linux/virtio_mmio.h
include/linux/virtio_ring.h
include/linux/virtio_scsi.h
include/linux/virtio.h
include/linux/vring.h

include/uapi/linux/virtio_9p.h
include/uapi/linux/virtio_balloon.h
include/uapi/linux/virtio_blk.h
include/uapi/linux/virtio_config.h
include/uapi/linux/virtio_console.h
include/uapi/linux/virtio_ids.h
include/uapi/linux/virtio_net.h
include/uapi/linux/virtio_pci.h
include/uapi/linux/virtio_ring.h
include/uapi/linux/virtio_rng.h

tools/virtio/linux/virtio_config.h
tools/virtio/linux/virtio_ring.h
tools/virtio/linux/virtio.h
tools/virtio/linux/vring.h
tools/virtio/vitrio_test.c
tools/virtio/vringh_test.c

linux-3.10
 ├─ drivers
 |   ├─ block
 |   |   └─ virtio_blk.c
 |   |
 |   ├─ char
 |   |   ├─ hw_random
 |   |   |   └─ virtio_rng.c
 |   |   |
 |   |   └─ virtio_console.c
 |   |
 |   ├─ net
 |   |   └─ virtio_net.c
 |   |
 |   ├─ scsi
 |   |   └─ virtio_scsi.c
 |   |   
 |   └─ virtio
 |       ├─ virtio_balloon.c
 |       ├─ virtio_mmio.c
 |       ├─ virtio_pci.c
 |       ├─ virtio_ring.c
 |       └─ virtio.c 
 |
 ├─ include
 |   ├─ linux
 |   |   ├─ virtio_caif.h
 |   |   ├─ virtio_config.h
 |   |   ├─ virtio_console.h
 |   |   ├─ virtio_mmio.h
 |   |   ├─ virtio_ring.h
 |   |   ├─ virtio_scsi.h
 |   |   ├─ virtio.h
 |   |   └─ vring.h
 |   |
 |   └─ uapi
 |       └─ linux
 |           ├─ virtio_9p.h
 |           ├─ virtio_balloon.h
 |           ├─ virtio_blk.h
 |           ├─ virtio_config.h
 |           ├─ virtio_console.h
 |           ├─ virtio_ids.h
 |           ├─ virtio_net.h
 |           ├─ virtio_pci.h    
 |           ├─ virtio_ring.h
 |           └─ virtio_rng.h
 |
 └─ tools
     └─ virtio
         ├─ linux
         |   ├─ virtio_config.h
         |   ├─ virtio_ring.h
         |   ├─ virtio.h
         |   └─ vring.h
         |
         ├─ virtio_test.c
         └─ vringh_test.c
</code></pre>
<h5 id="类结构层次"><a href="#类结构层次" class="headerlink" title="类结构层次"></a>类结构层次</h5><p>在 <strong>virtio 前端驱动</strong>即<strong>客户机内核</strong>中，virtio 的<strong>类层次结构</strong>如下图所示：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2019/09/02/virtio-in-kvm/virtio-data-structure.gif" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>
<h5 id="virtio-driver"><a href="#virtio-driver" class="headerlink" title="virtio_driver"></a>virtio_driver</h5><p>最顶级的是<code>virtio_driver</code>，在客户机 OS 中表示<strong>前端驱动程序</strong>，在<code>include/linux/virtio.h</code>中定义：</p>
<pre><code class="lang-c">/**
 * virtio_driver - operations for a virtio I/O driver
 * @driver: underlying device driver (populate name and owner).
 * @id_table: the ids serviced by this driver.
 * @feature_table: an array of feature numbers supported by this driver.
 * @feature_table_size: number of entries in the feature table array.
 * @probe: the function to call when a device is found.  Returns 0 or -errno.
 * @remove: the function to call when a device is removed.
 * @config_changed: optional function to call when the device configuration
 *    changes; may be called in interrupt context.
 */
struct virtio_driver {
    struct device_driver driver;
    const struct virtio_device_id *id_table;
    const unsigned int *feature_table;
    unsigned int feature_table_size;
    int (*probe)(struct virtio_device *dev);
    void (*scan)(struct virtio_device *dev);
    void (*remove)(struct virtio_device *dev);
    void (*config_changed)(struct virtio_device *dev);
#ifdef CONFIG_PM
    int (*freeze)(struct virtio_device *dev);
    int (*restore)(struct virtio_device *dev);
#endif
};
</code></pre>
<h5 id="virtio-device-id"><a href="#virtio-device-id" class="headerlink" title="virtio_device_id"></a>virtio_device_id</h5><p>每个 virtio 设备都有其对应的<code>virtio_device_id</code>，该结构体在<code>include/linux/mod_devicetable.h</code>中定义：</p>
<pre><code class="lang-c">struct virtio_device_id {
    __u32 device;
    __u32 vendor;
};
#define VIRTIO_DEV_ANY_ID    0xffffffff
</code></pre>
<h5 id="virtio-device"><a href="#virtio-device" class="headerlink" title="virtio_device"></a>virtio_device</h5><p>与驱动程序匹配的设备由<code>virtio_device</code>封装，它表示<strong>在客户机 OS 中的设备</strong>，在<code>include/linux/virtio.h</code>中定义：</p>
<pre><code class="lang-c">/**
 * virtio_device - representation of a device using virtio
 * @index: unique position on the virtio bus
 * @dev: underlying device.
 * @id: the device type identification (used to match it with a driver).
 * @config: the configuration ops for this device.
 * @vringh_config: configuration ops for host vrings.
 * @vqs: the list of virtqueues for this device.
 * @features: the features supported by both driver and device.
 * @priv: private pointer for the driver&#39;s use.
 */
struct virtio_device {
    int index;
    struct device dev;
    struct virtio_device_id id;
    const struct virtio_config_ops *config;
    const struct vringh_config_ops *vringh_config;
    struct list_head vqs;
    /* Note that this is a Linux set_bit-style bitmap. */
    unsigned long features[1];
    void *priv;
};
</code></pre>
<h5 id="virtio-config-ops"><a href="#virtio-config-ops" class="headerlink" title="virtio_config_ops"></a>virtio_config_ops</h5><p>每一个<code>virtio_device</code>都有一个<code>virtio_config_ops</code>类型的指针<code>*config</code>，它定义了<strong>配置 virtio 设备的操作</strong>，该结构体在<code>include/linux/virtio_config.h</code>中定义：</p>
<pre><code class="lang-c">/**
 * virtio_config_ops - operations for configuring a virtio device
 * @get: read the value of a configuration field
 * @set: write the value of a configuration field
 * @get_status: read the status byte
 * @set_status: write the status byte
 * @reset: reset the device
 * @find_vqs: find virtqueues and instantiate them.
 * @del_vqs: free virtqueues found by find_vqs().
 * @get_features: get the array of feature bits for this device.
 * @finalize_features: confirm what device features we&#39;ll be using.
 * @bus_name: return the bus name associated with the device
 * @set_vq_affinity: set the affinity for a virtqueue.
 */
struct virtio_config_ops {
    void (*get)(struct virtio_device *vdev, unsigned offset,
            void *buf, unsigned len);
    void (*set)(struct virtio_device *vdev, unsigned offset,
            const void *buf, unsigned len);
    u8 (*get_status)(struct virtio_device *vdev);
    void (*set_status)(struct virtio_device *vdev, u8 status);
    void (*reset)(struct virtio_device *vdev);
    int (*find_vqs)(struct virtio_device *, unsigned nvqs,
            struct virtqueue *vqs[],
            vq_callback_t *callbacks[],
            const char *names[]);
    void (*del_vqs)(struct virtio_device *);
    u32 (*get_features)(struct virtio_device *vdev);
    void (*finalize_features)(struct virtio_device *vdev);
    const char *(*bus_name)(struct virtio_device *vdev);
    int (*set_vq_affinity)(struct virtqueue *vq, int cpu);
};
</code></pre>
<h5 id="virtqueue"><a href="#virtqueue" class="headerlink" title="virtqueue"></a>virtqueue</h5><p>每一个<code>virtqueue</code>包含了对应的<code>virtio_device</code>以及对应的<strong>队列操作回调函数</strong>，它在<code>include/linux/virtio.h</code>中定义：</p>
<pre><code class="lang-c">/**
 * virtqueue - a queue to register buffers for sending or receiving.
 * @list: the chain of virtqueues for this device
 * @callback: the function to call when buffers are consumed (can be NULL).
 * @name: the name of this virtqueue (mainly for debugging)
 * @vdev: the virtio device this queue was created for.
 * @priv: a pointer for the virtqueue implementation to use.
 * @index: the zero-based ordinal number for this queue.
 * @num_free: number of elements we expect to be able to fit.
 *
 * A note on @num_free: with indirect buffers, each buffer needs one
 * element in the queue, otherwise a buffer will need one element per
 * sg element.
 */
struct virtqueue {
    struct list_head list;
    void (*callback)(struct virtqueue *vq);
    const char *name;
    struct virtio_device *vdev;
    unsigned int index;
    unsigned int num_free;
    void *priv;
};
</code></pre>
<h3 id="5-相关数据结构"><a href="#5-相关数据结构" class="headerlink" title="5. 相关数据结构"></a>5. 相关数据结构</h3><h4 id="5-1-前端-Kernel"><a href="#5-1-前端-Kernel" class="headerlink" title="5.1 前端 Kernel"></a>5.1 前端 Kernel</h4><h5 id="virtio-driver-1"><a href="#virtio-driver-1" class="headerlink" title="virtio_driver"></a>virtio_driver</h5><p>在<code>include/linux/virtio.h</code>中定义：</p>
<pre><code class="lang-c">/**
 * virtio_driver - operations for a virtio I/O driver
 * @driver: underlying device driver (populate name and owner).
 * @id_table: the ids serviced by this driver.
 * @feature_table: an array of feature numbers supported by this driver.
 * @feature_table_size: number of entries in the feature table array.
 * @probe: the function to call when a device is found.  Returns 0 or -errno.
 * @remove: the function to call when a device is removed.
 * @config_changed: optional function to call when the device configuration
 *    changes; may be called in interrupt context.
 */
struct virtio_driver {
    struct device_driver driver;
    const struct virtio_device_id *id_table;
    const unsigned int *feature_table;
    unsigned int feature_table_size;
    int (*probe)(struct virtio_device *dev);
    void (*scan)(struct virtio_device *dev);
    void (*remove)(struct virtio_device *dev);
    void (*config_changed)(struct virtio_device *dev);
#ifdef CONFIG_PM
    int (*freeze)(struct virtio_device *dev);
    int (*restore)(struct virtio_device *dev);
#endif
};
</code></pre>
<p>这里的<code>virtio_device_id</code>有两个字段：</p>
<pre><code class="lang-c">struct virtio_device_id {
    __u32 device;
    __u32 vendor;
};
#define VIRTIO_DEV_ANY_ID    0xffffffff
</code></pre>
<h5 id="virtio-device-1"><a href="#virtio-device-1" class="headerlink" title="virtio_device"></a>virtio_device</h5><p>在<code>include/linux/virtio.h</code>中定义：</p>
<pre><code class="lang-c">/**
 * virtio_device - representation of a device using virtio
 * @index: unique position on the virtio bus
 * @dev: underlying device.
 * @id: the device type identification (used to match it with a driver).
 * @config: the configuration ops for this device.
 * @vringh_config: configuration ops for host vrings.
 * @vqs: the list of virtqueues for this device.
 * @features: the features supported by both driver and device.
 * @priv: private pointer for the driver&#39;s use.
 */
struct virtio_device {
    int index;
    struct device dev;
    struct virtio_device_id id;
    const struct virtio_config_ops *config;
    const struct vringh_config_ops *vringh_config;
    struct list_head vqs;
    /* Note that this is a Linux set_bit-style bitmap. */
    unsigned long features[1];
    void *priv;
};
</code></pre>
<h5 id="virtio-config-ops-1"><a href="#virtio-config-ops-1" class="headerlink" title="virtio_config_ops"></a>virtio_config_ops</h5><p>在<code>include/linux/virtio_config.h</code>中定义：</p>
<pre><code class="lang-c">/**
 * virtio_config_ops - operations for configuring a virtio device
 * @get: read the value of a configuration field
 *    vdev: the virtio_device
 *    offset: the offset of the configuration field
 *    buf: the buffer to write the field value into.
 *    len: the length of the buffer
 * @set: write the value of a configuration field
 *    vdev: the virtio_device
 *    offset: the offset of the configuration field
 *    buf: the buffer to read the field value from.
 *    len: the length of the buffer
 * @get_status: read the status byte
 *    vdev: the virtio_device
 *    Returns the status byte
 * @set_status: write the status byte
 *    vdev: the virtio_device
 *    status: the new status byte
 * @reset: reset the device
 *    vdev: the virtio device
 *    After this, status and feature negotiation must be done again
 *    Device must not be reset from its vq/config callbacks, or in
 *    parallel with being added/removed.
 * @find_vqs: find virtqueues and instantiate them.
 *    vdev: the virtio_device
 *    nvqs: the number of virtqueues to find
 *    vqs: on success, includes new virtqueues
 *    callbacks: array of callbacks, for each virtqueue
 *        include a NULL entry for vqs that do not need a callback
 *    names: array of virtqueue names (mainly for debugging)
 *        include a NULL entry for vqs unused by driver
 *    Returns 0 on success or error status
 * @del_vqs: free virtqueues found by find_vqs().
 * @get_features: get the array of feature bits for this device.
 *    vdev: the virtio_device
 *    Returns the first 32 feature bits (all we currently need).
 * @finalize_features: confirm what device features we&#39;ll be using.
 *    vdev: the virtio_device
 *    This gives the final feature bits for the device: it can change
 *    the dev-&gt;feature bits if it wants.
 * @bus_name: return the bus name associated with the device
 *    vdev: the virtio_device
 *      This returns a pointer to the bus name a la pci_name from which
 *      the caller can then copy.
 * @set_vq_affinity: set the affinity for a virtqueue.
 */
typedef void vq_callback_t(struct virtqueue *);
struct virtio_config_ops {
    void (*get)(struct virtio_device *vdev, unsigned offset,
            void *buf, unsigned len);
    void (*set)(struct virtio_device *vdev, unsigned offset,
            const void *buf, unsigned len);
    u8 (*get_status)(struct virtio_device *vdev);
    void (*set_status)(struct virtio_device *vdev, u8 status);
    void (*reset)(struct virtio_device *vdev);
    int (*find_vqs)(struct virtio_device *, unsigned nvqs,
            struct virtqueue *vqs[],
            vq_callback_t *callbacks[],
            const char *names[]);
    void (*del_vqs)(struct virtio_device *);
    u32 (*get_features)(struct virtio_device *vdev);
    void (*finalize_features)(struct virtio_device *vdev);
    const char *(*bus_name)(struct virtio_device *vdev);
    int (*set_vq_affinity)(struct virtqueue *vq, int cpu);
};
</code></pre>
<h5 id="virtqueue-1"><a href="#virtqueue-1" class="headerlink" title="virtqueue"></a>virtqueue</h5><p>在<code>include/linux/virtio.h</code>中定义：</p>
<pre><code class="lang-c">/**
 * virtqueue - a queue to register buffers for sending or receiving.
 * @list: the chain of virtqueues for this device
 * @callback: the function to call when buffers are consumed (can be NULL).
 * @name: the name of this virtqueue (mainly for debugging)
 * @vdev: the virtio device this queue was created for.
 * @priv: a pointer for the virtqueue implementation to use.
 * @index: the zero-based ordinal number for this queue.
 * @num_free: number of elements we expect to be able to fit.
 *
 * A note on @num_free: with indirect buffers, each buffer needs one
 * element in the queue, otherwise a buffer will need one element per
 * sg element.
 */
struct virtqueue {
    struct list_head list;
    void (*callback)(struct virtqueue *vq);
    const char *name;
    struct virtio_device *vdev;
    unsigned int index;
    unsigned int num_free;
    void *priv;
};
</code></pre>
<h4 id="5-2-后端-QEMU"><a href="#5-2-后端-QEMU" class="headerlink" title="5.2 后端 QEMU"></a>5.2 后端 QEMU</h4><h5 id="VirtQueue"><a href="#VirtQueue" class="headerlink" title="VirtQueue"></a>VirtQueue</h5><p>在<code>hw/virtio/virtio.c</code>中定义：</p>
<pre><code class="lang-c">struct VirtQueue
{
    VRing vring;

    /* Next head to pop */
    uint16_t last_avail_idx;

    /* Last avail_idx read from VQ. */
    uint16_t shadow_avail_idx;

    uint16_t used_idx;

    /* Last used index value we have sjjignalled on */
    uint16_t signalled_used;

    /* Last used index value we have signalled on */
    bool signalled_used_valid;

    /* Notification enabled? */
    bool notification;

    uint16_t queue_index;

    int inuse;

    uint16_t vector;
    void (*handle_output)(VirtIODevice *vdev, VirtQueue *vq);
    void (*handle_aio_output)(VirtIODevice *vdev, VirtQueue *vq);
    VirtIODevice *vdev;
    EventNotifier guest_notifier;
    EventNotifier host_notifier;
    QLIST_ENTRY(VirtQueue) node;
};
</code></pre>
<h5 id="VRing"><a href="#VRing" class="headerlink" title="VRing"></a>VRing</h5><p>在<code>hw/virtio/virtio.c</code>中定义：</p>
<pre><code class="lang-c">typedef struct VRing
{
    unsigned int num;
    unsigned int num_default;
    unsigned int align;
    hwaddr desc;
    hwaddr avail;
    hwaddr used;
} VRing;
</code></pre>
<p><strong><em>未完待续…</em></strong></p>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><h4 id="相关博客"><a href="#相关博客" class="headerlink" title="相关博客"></a>相关博客</h4><blockquote>
<ol>
<li><a href="http://smilejay.com/2012/11/virtio-overview/" target="_blank" rel="noopener">Virtio 概述和基本原理（KVM 半虚拟化驱动）| 笑遍世界</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/linux/l-virtio/" target="_blank" rel="noopener">Virtio：针对 Linux 的 I/O 虚拟化框架 | IBM Developer</a></li>
<li><a href="https://my.oschina.net/davehe/blog/130124" target="_blank" rel="noopener">virtio 基本原理 (kvm 半虚拟化驱动) | 开源中国</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1087117" target="_blank" rel="noopener">说一说虚拟化绕不开的 io 半虚拟化 | 腾讯云加社区</a></li>
<li><a href="http://oenhan.com/virtio-vring" target="_blank" rel="noopener">Virtio Vring 工作机制分析 | OenHan</a></li>
<li><a href="http://oenhan.com/kvm-virtio-block-src" target="_blank" rel="noopener">KVM Virtio Block 源代码分析 | OenHan</a></li>
<li><a href="https://blog.csdn.net/leoufung/article/details/48781135" target="_blank" rel="noopener">vring的创建(基于kernel 3.10, qemu2.0.0) - leoufung| CSDN</a></li>
<li><a href="https://blog.csdn.net/leoufung/article/details/48781141" target="_blank" rel="noopener">QEMU 通过virtio接收报文处理流程（QEMU2.0.0）- leoufung | CSDN</a></li>
<li><a href="https://blog.csdn.net/leoufung/article/details/52955535" target="_blank" rel="noopener">VIRTIO 的 vring 收发队列创建流程 - leoufung | CSDN</a></li>
<li><a href="https://blog.csdn.net/leoufung/article/details/53584970" target="_blank" rel="noopener">VIRTIO 中的前后端配合限速分析 - leoufung | CSDN</a></li>
<li><a href="http://www.hanbaoying.com/2017/08/30/virtio-blk-io-path.html" target="_blank" rel="noopener">virtio 路径 | 随便写写</a></li>
</ol>
</blockquote>
<h4 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h4><blockquote>
<ol>
<li><a href="http://www.linux-kvm.org/page/Virtio" target="_blank" rel="noopener">Virtio | KVM Documents</a></li>
<li><a href="https://ozlabs.org/~rusty/virtio-spec/virtio-paper.pdf" target="_blank" rel="noopener">virtio: Towards a De-Facto Standard For Virtual I/O Devices - Rusty Russell | PDF</a></li>
<li><a href="https://www.linux-kvm.org/images/f/f9/2012-forum-virtio-blk-performance-improvement.pdf" target="_blank" rel="noopener">Virtio-blk Performance Improvement | KVM Forum 2012</a></li>
</ol>
</blockquote>
<h4 id="太初有道-博客园"><a href="#太初有道-博客园" class="headerlink" title="太初有道 - 博客园"></a>太初有道 - 博客园</h4><blockquote>
<ol>
<li><a href="https://www.cnblogs.com/ck1020/p/6044134.html" target="_blank" rel="noopener">Virtio 前端驱动详解 - 太初有道 | cnblogs</a></li>
<li><a href="https://www.cnblogs.com/ck1020/p/5939777.html" target="_blank" rel="noopener">Virtio 后端驱动详解 - 太初有道 | cnblogs</a></li>
<li><a href="https://www.cnblogs.com/ck1020/p/6066007.html" target="_blank" rel="noopener">Virtio 前后端 notify 机制详解 - 太初有道 | cnblogs</a></li>
<li><a href="https://www.cnblogs.com/ck1020/p/6043054.html" target="_blank" rel="noopener">intel EPT 机制详解 - 太初有道 | cnblogs</a></li>
<li><a href="https://www.cnblogs.com/ck1020/p/6920765.html" target="_blank" rel="noopener">KVM 中 EPT 逆向映射机制分析 - 太初有道 | cnblogs</a></li>
<li><a href="https://www.cnblogs.com/ck1020/p/6753206.html" target="_blank" rel="noopener">QEMU 进程页表和 EPT 的同步问题 - 太初有道 | cnblogs</a></li>
<li><a href="https://www.cnblogs.com/ck1020/p/7840470.html" target="_blank" rel="noopener">KVM vCPU 线程调度问题的讨论 - 太初有道 | cnblogs</a></li>
<li><a href="https://www.cnblogs.com/ck1020/p/7204769.html" target="_blank" rel="noopener">virtio 之 vhost 工作原理简析 - 太初有道 | cnblogs</a></li>
<li><a href="https://www.cnblogs.com/ck1020/p/5942703.html" target="_blank" rel="noopener">PCI 设备详解一 - 太初有道 | cnblogs</a></li>
</ol>
</blockquote>
<h4 id="Lauren-的博客"><a href="#Lauren-的博客" class="headerlink" title="Lauren 的博客"></a>Lauren 的博客</h4><blockquote>
<ol>
<li><a href="http://lihanlu.cn/virtio-introduction/" target="_blank" rel="noopener">Virtio 原理简介 | Lauren’s blog</a></li>
<li><a href="http://lihanlu.cn/virtio-net-xmit/" target="_blank" rel="noopener">Virtio 网络发包过程分析 | Lauren’s blog</a></li>
<li><a href="http://lihanlu.cn/virtio-frontend-kick/" target="_blank" rel="noopener">virtio 前端通知机制分析 | Lauren’s blog</a></li>
<li><a href="http://lihanlu.cn/spinlock/" target="_blank" rel="noopener">也说自旋锁 | Lauren’s blog</a></li>
<li><a href="http://lihanlu.cn/qspinlock/" target="_blank" rel="noopener">也说自旋锁2 —— qspinlock | Lauren’s blog</a></li>
</ol>
</blockquote>
<h4 id="其他不错的"><a href="#其他不错的" class="headerlink" title="其他不错的"></a>其他不错的</h4><blockquote>
<ol>
<li><a href="https://blog.csdn.net/scaleqiao/article/details/45938369" target="_blank" rel="noopener">Virtio 学习笔记（一）：简介 - 瞧见风 | CSDN</a></li>
<li><a href="https://cloud.tencent.com/document/product/213/9929" target="_blank" rel="noopener">Linux 系统检查 virtio 驱动 | 腾讯云文档中心</a></li>
<li><a href="https://www.cnblogs.com/chendb/p/9528872.html" target="_blank" rel="noopener">Virtio 基本概念和设备操作 - Db_Chen | cnblogs</a></li>
<li><a href="https://www.cnblogs.com/super-sos/p/9044154.html" target="_blank" rel="noopener">virtio 简介 - supersos | cnblogs</a></li>
<li><a href="https://www.cnblogs.com/snake-hand/p/3181631.html" target="_blank" rel="noopener">KVM 地址翻译流程及 EPT 页表的建立过程 - 小C爱学习 | cnblogs</a></li>
</ol>
</blockquote>
<h4 id="团子的小窝"><a href="#团子的小窝" class="headerlink" title="团子的小窝"></a>团子的小窝</h4><blockquote>
<ol>
<li><a href="http://kodango.com/cpu-topology?replytocom=181842#respond" target="_blank" rel="noopener">NUMA 与 SMP | 团子的小窝</a></li>
<li><a href="http://kodango.com/article-series" target="_blank" rel="noopener">系列连载文章 | 团子的小窝</a></li>
</ol>
</blockquote>
<h4 id="QEMU"><a href="#QEMU" class="headerlink" title="QEMU"></a>QEMU</h4><blockquote>
<ol>
<li><a href="https://blog.csdn.net/scaleqiao/article/details/50787340" target="_blank" rel="noopener">QEMU/KVM 中的 tracing 工具 - 瞧见风 | CSDN</a></li>
<li><a href="http://lihanlu.cn/qemu-net/" target="_blank" rel="noopener">QEMU 网络虚拟化分析 | Lauren’s blog</a></li>
<li><a href="http://lihanlu.cn/qemu-gdb-kernel/" target="_blank" rel="noopener">利用 QEMU GDB 调试 Kernel | Lauren’s blog</a></li>
</ol>
</blockquote>
<h4 id="Linux-云计算网络"><a href="#Linux-云计算网络" class="headerlink" title="Linux 云计算网络"></a>Linux 云计算网络</h4><blockquote>
<ol>
<li><a href="https://www.cnblogs.com/bakari/p/8309638.html" target="_blank" rel="noopener">Virtio 简介 | Linux 云计算网络</a></li>
<li><a href="https://mp.weixin.qq.com/s/TLDlTSaGM3MNYBc8wrLq0g" target="_blank" rel="noopener">Linux 网络基础知识划重点版（上）| Linux 云计算网络</a></li>
<li><a href="https://mp.weixin.qq.com/s/BHmryqFP1av4HCuPwiFR4Q" target="_blank" rel="noopener">Linux 网络基础知识划重点版（下）| Linux 云计算网络</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzI1OTY2MzMxOQ==&amp;mid=2247486316&amp;idx=1&amp;sn=46dd5f66446b510b8aa8388bb929e2ba&amp;chksm=ea743fd4dd03b6c2b6a4be69deb2b71e8bb87467667dc6573f0f2cca76c35f8a2680ac97563b&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">50 个你必须掌握的 Kubernetes 面试题 | Linux 云计算网络</a></li>
</ol>
</blockquote>
<h4 id="王子阳-中科院信息工程研究所"><a href="#王子阳-中科院信息工程研究所" class="headerlink" title="王子阳 - 中科院信息工程研究所"></a>王子阳 - 中科院信息工程研究所</h4><blockquote>
<ol>
<li><a href="http://juniorprincewang.github.io/2018/03/01/virtio%E5%AD%A6%E4%B9%A0/#" target="_blank" rel="noopener">virtio 学习 | 王子阳</a></li>
<li><a href="http://juniorprincewang.github.io/2019/08/22/%E6%B5%AE%E7%82%B9%E6%95%B0%E6%8B%BE%E9%81%97/#" target="_blank" rel="noopener">浮点数拾遗 | 王子阳</a></li>
</ol>
</blockquote>
<div><strong>🚩推荐阅读</strong>（由<a href="https://github.com/huiwang/hexo-recommended-posts">hexo文章推荐插件</a>驱动）<ul><li><a href="https://abelsu7.top/2019/11/19/recent-virt-notes/">虚拟化相关资料收集</a></li><li><a href="https://abelsu7.top/2019/08/26/compile-kvm-module/">单独编译 KVM 内核模块</a></li><li><a href="https://abelsu7.top/2019/08/11/kvm-api-overview/">Kernel 2.6.32 中的 KVM API 概述</a></li><li><a href="https://abelsu7.top/2019/08/11/qemu-main-func/">QEMU 1.2.0 入口 main() 函数调用流程分析</a></li><li><a href="http://www.borgor.cn/2017-10-23/16f315c1.html">迁移 VMware 虚拟机到 KVM</a></li><li><a href="https://zsnmwy.net/47278.html">微星B350M 虚拟化开启 AMD-V</a></li></ul></div>
        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2019-11-19T13:34:08.676Z" itemprop="dateUpdated">2019-11-19 21:34:08</time>
</span><br>


        
        文章发布地址：<a href="/2019/09/02/virtio-in-kvm/" target="_blank" rel="external">https://abelsu7.top/2019/09/02/virtio-in-kvm/</a>
        
    </div>
    
    <footer>
        <a href="https://abelsu7.top">
            <img src="/img/fong.jpg" alt="Abel Su">
            Abel Su
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/KVM/">KVM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/QEMU/">QEMU</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtio/">virtio</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/虚拟化/">虚拟化</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://abelsu7.top/2019/09/02/virtio-in-kvm/&title=《半虚拟化 I/O 框架 virtio》 — Keep Coding&pic=https://abelsu7.top/img/fong.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://abelsu7.top/2019/09/02/virtio-in-kvm/&title=《半虚拟化 I/O 框架 virtio》 — Keep Coding&source=
virtio 框架学习，更新中…


                
                    
                   ..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://abelsu7.top/2019/09/02/virtio-in-kvm/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《半虚拟化 I/O 框架 virtio》 — Keep Coding&url=https://abelsu7.top/2019/09/02/virtio-in-kvm/&via=https://abelsu7.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://abelsu7.top/2019/09/02/virtio-in-kvm/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2019/09/06/gopls-guide/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">VS Code 中使用 gopls 补全 Go 代码</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2019/08/26/most-used-commands-to-diagnose-linux/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Linux 系统常用监控命令</h4>
      </a>
    </div>
  
</nav>



    











    <!-- Valine Comments -->
    <div class="comments vcomment v" id="vcomments"></div>
    <!-- <div class="comment" id="comment"></div> -->
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script>
    <!-- <script src="//t1.aixinxi.net/o_1c3n4pim01nl3jg91b6l1kjtkvsa.js"></script> -->
    <!-- <script src="/js/Valine.min.js"></script> -->
    <!-- <script src="https://cdnjs.cat.net/ajax/libs/jquery/3.2.1/jquery.min.js"></script> -->
    <script src="//cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <!-- Valine Comments script -->
    <script>
        var GUEST_INFO = ['nick','mail','link'];
        var guest_info = 'nick,mail,link'.split(',').filter(function(item){
          return GUEST_INFO.indexOf(item) > -1
        });
        new Valine({
            av: AV,
            // el: '#comments',
            el: '#vcomments',
            emoticon_url: 'https://abelsu7.top/alu', //表情图片网址
            emoticon_list: ["赞一个.png","坐等.png","长草.png","阴暗.png","邪恶.png","小眼睛.png","想一想.png","献黄瓜.png","献花.png","喜极而泣.png","无语.png","无所谓.png","无奈.png","投降.png","深思.png","期待.png","狂汗.png","蜡烛.png","看不见.png","惊喜.png","击掌.png","欢呼.png","得意.png","不出所料.png","观察.png"],//表情图片文件名
            // notify: 'false' == 'false',
            // verify: 'false' == 'false',
            // notify: 'false',
            // verify: 'false',
            notify: false,
            verify: false,
            appId: "aP2YQo0mfrRpTLrLb1bchILb-gzGzoHsz",
            appKey: "Cp82umQdGScRRFUYLmob6yyK",
            avatar: "mp",
            placeholder: "Write a comment",
            guest_info: guest_info.length == 0 ? GUEST_INFO : guest_info,
            pageSize: "10"
        })
    </script>
    <!-- Valine Comments end -->











</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        感谢支持！
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.png" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/wechat.png" data-alipay="/img/alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-item switch">切换</span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


            <p>
                
                    <span>
                        <a href="/atom.xml" target="_blank" class="rss" title="rss">
                            <i class="icon icon-lg icon-rss"></i>
                        </a>
                    </span>
                    
                        <span>
                            博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a>
                        </span>
            </p>
    </div>
    <div class="bottom">
        <p>
            <span>
                Abel Su &copy;
                    
                        2018 -
                            
                                2019
            </span>
            <span>
                
                    <a href="http://beian.miit.gov.cn/" target="_blank">
                        粤ICP备16068788号-2
                    </a>
                    <br>
                    
                        Power by
                        <a href="http://hexo.io/" target="_blank">Hexo</a> Theme
                        <a href="https://github.com/abelsu7/hexo-theme-indigo-plus" target="_blank">indigo plus</a>
                        <p>Hosted by <a href="https://pages.github.com" target="_blank" style="font-weight: bold">Github Pages</a></p>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>
<a href="javascript:;" id="gobottom" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-comments"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://abelsu7.top/2019/09/02/virtio-in-kvm/&title=《半虚拟化 I/O 框架 virtio》 — Keep Coding&pic=https://abelsu7.top/img/fong.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://abelsu7.top/2019/09/02/virtio-in-kvm/&title=《半虚拟化 I/O 框架 virtio》 — Keep Coding&source=
virtio 框架学习，更新中…


                
                    
                   ..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://abelsu7.top/2019/09/02/virtio-in-kvm/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《半虚拟化 I/O 框架 virtio》 — Keep Coding&url=https://abelsu7.top/2019/09/02/virtio-in-kvm/&via=https://abelsu7.top" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://abelsu7.top/2019/09/02/virtio-in-kvm/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACI0lEQVR42u3aS25DIRBE0bf/TRMpIw8cqOrCjmguo8hS4B0Grf7wPPIav0v5fbys+e9jup5PLBgwYBzLULabHzNK66/rKFJhwIBxAWMeTN2AO4+HSiB2z4UBAwaM+WFJ2FUCPQwYMGC4jHmRqYRONzWEAQMGDDfw6cmcUhL/Qy0OAwaMAxnuYOCbf39wvgEDBoxDGHlD3x0b5MOAN2fBgAGjNcMtVt02WfK72+yDAQNGb0atNeaGUaXBVxtIwIABozcj/6Bd4bWWbsKAAeM2hh7ytg0d5f0X58KAAaM1o1bEzj8iCb5uMgoDBowbGPln5W1997IW/UIYMGC0YyTPTN0HXrWRpz4QhQEDRleG/qG1cUKt0ea+AYMBA8ZtjKRB5l6Eu4NRxMKAAaMRww5t5mOIJPlTiupqhIYBA8bZDLccVS4iSvtKCSsMGDA6MfISdFcR67b8YMCAcSejNhhQeHmAXuwPAwaMyxi7PsttsUVFLAwYMFoz9Ha/0lxzGe7TVek6YMCA0Y6x63mW+yBVHypIDUEYMGC0ZiRhV8HoDTs99ZT+CwYMGI0Yw1xJyZpczeKKYcCA0ZpRa5+5W+ej0PwZBwwYME5nuCndfDv9aZe7g1G4woABoynDbeK7R7q8zU8uYMCAcRljbzrohvJFaggDBozrGUmDLC9TF6EZBgwYFzDc0aPehvvSJBYGDBitGe5gQAEoY4NaWRsNMmHAgHEe4wdw6PUbiZSfFwAAAABJRU5ErkJggg==" alt="微信分享二维码">
</div>




    <script src="//cdn.jsdelivr.net/npm/node-waves@0.7.6/src/js/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="/js/main.min.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.2" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script src="/js/prism.min.js?v=1.7.2"></script>
<script src="/js/prism-vim.min.js?v=1.7.2"></script>
</body>
</html>
